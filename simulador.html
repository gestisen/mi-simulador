<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Simulador de financiación</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f6f8fa;
        margin: 0;
        padding: 0;
        color: #333;
    }
    .fade-in {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.8s ease forwards;
    }
    @keyframes fadeInUp {
        to { opacity: 1; transform: translateY(0); }
    }
    header {
        background-color: #002147;
        color: white;
        padding: 20px;
        text-align: center;
    }
    header img {
        max-height: 60px;
        margin-bottom: 10px;
    }
    header h1 {
        margin: 5px 0;
        font-size: 1.4em;
    }
    form {
        max-width: 700px;
        background: white;
        margin: 20px auto;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    fieldset {
        border: 2px solid #002147;
        border-radius: 8px;
        margin-bottom: 20px;
        padding: 15px;
    }
    legend {
        font-weight: bold;
        color: #002147;
        padding: 0 10px;
    }
    label {
        display: block;
        margin-top: 12px;
        font-weight: bold;
    }
    input, select {
        width: 60%;
        padding: 8px;
        margin-top: 4px;
        border-radius: 5px;
        border: 1px solid #ccc;
        transition: border-color 0.2s ease, background-color 0.3s ease;
    }
    input:invalid {
        border-color: red;
    }
    input.valid {
        border-color: green;
    }
    input.disabled, select.disabled {
        background-color: #e0e0e0 !important;
        color: #555 !important;
        cursor: not-allowed;
    }
    .error {
        color: red;
        font-size: 0.85em;
        display: none;
    }
    .error.show {
        display: block;
    }
    .section-divider {
        margin: 15px 0;
        padding: 10px;
        background-color: #f0f4f8;
        border-left: 4px solid #002147;
        font-size: 0.9em;
    }
    .importe-plazo {
        display: flex;
        justify-content: space-between;
        gap: 20px;
    }
    .importe-plazo div {
        flex: 1;
    }
    button {
        background-color: #002147;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
    }
    button:disabled {
        background-color: #555;
        cursor: not-allowed;
    }
    .resultados {
        margin-top: 15px;
        padding: 10px;
        background: #eaf1f8;
        border-radius: 5px;
        border: 1px solid #b5cce6;
        opacity: 0;
        transition: opacity 0.4s ease;
    }
    .resultados.show {
        opacity: 1;
    }
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 5px;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.4s ease, transform 0.4s ease;
        z-index: 9999;
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
</style>
</head>
<body>

<header class="fade-in" style="animation-delay:0.1s;">
    <img src="https://i.postimg.cc/RNDGS5W7/isen-centro-univ.jpg" alt="Logo" />
    <h1 id="facturaInfo">Cargando información de la factura...</h1>
</header>

<form id="financiacionForm" novalidate class="fade-in" style="animation-delay:0.3s;">
    <fieldset>
        <legend>Datos del Titular de la Financiación</legend>
        <label>Nombre:
            <input type="text" id="nombre" required>
            <div class="error" id="errNombre">Campo obligatorio</div>
        </label>
        <label>Apellido 1:
            <input type="text" id="apellido1" required>
            <div class="error" id="errApellido1">Campo obligatorio</div>
        </label>
        <label>Apellido 2:
            <input type="text" id="apellido2" required>
            <div class="error" id="errApellido2">Campo obligatorio</div>
        </label>
        <label>Teléfono móvil:
            <input type="tel" id="telefono" required pattern="^[0-9]{9}$">
            <div class="error" id="errTelefono">Debe tener 9 dígitos numéricos</div>
        </label>
        <label>Email:
            <input type="email" id="email" required>
            <div class="error" id="errEmail">Formato de email inválido</div>
        </label>
        <label>Fecha de Nacimiento:
            <input type="date" id="fechaNacimiento" required>
            <div class="error" id="errFecha">Debe ser mayor de 18 años</div>
        </label>
    </fieldset>

    <fieldset>
        <legend>Datos Solicitud Financiación</legend>
        <div class="section-divider">
            A continuación introduzca el importe a financiar y seleccione uno de los plazos disponibles...
        </div>
        <div class="importe-plazo">
            <div>
                <label>Importe (€):
                    <input type="number" id="importe" required>
                    <div class="error" id="errImporte">No puede superar el total de la factura</div>
                </label>
            </div>
            <div>
                <label>Plazo (meses):
                    <select id="plazo" required>
                        <option value="">Seleccione</option>
                        <option value="3">3</option>
                        <option value="6">6</option>
                        <option value="9">9</option>
                        <option value="12">12</option>
                    </select>
                    <div class="error" id="errPlazo">Seleccione un plazo</div>
                </label>
            </div>
        </div>
        <div class="resultados" id="resultadosCalculo"></div>
    </fieldset>

    <button type="submit" id="submitBtn" disabled>Enviar solicitud</button>
</form>

<div class="toast" id="toastMsg"></div>

<script>
    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");
    let importeFactura = 0;

    if (token) {
        const decoded = decodeURIComponent(token).split("|");
        importeFactura = parseFloat(decoded[4]);
        document.getElementById("facturaInfo").textContent = `Factura Nº ${decoded[3]} (${decoded[2]}) - Importe máximo: ${importeFactura.toFixed(2)} €`;
    }

    const form = document.getElementById("financiacionForm");
    const inputs = form.querySelectorAll("input, select");
    const submitBtn = document.getElementById("submitBtn");
    const resultados = document.getElementById("resultadosCalculo");

    function validarCampo(input, errorId, fnExtra = null) {
        const errorDiv = document.getElementById(errorId);
        let valido = input.checkValidity();
        if (fnExtra) valido = valido && fnExtra(input.value);
        if (!valido) {
            errorDiv.classList.add("show");
            input.classList.remove("valid");
        } else {
            errorDiv.classList.remove("show");
            input.classList.add("valid");
        }
        return valido;
    }

    function validarFormulario() {
        let valido = true;
        valido &= validarCampo(nombre, "errNombre");
        valido &= validarCampo(apellido1, "errApellido1");
        valido &= validarCampo(apellido2, "errApellido2");
        valido &= validarCampo(telefono, "errTelefono");
        valido &= validarCampo(email, "errEmail");
        valido &= validarCampo(fechaNacimiento, "errFecha", val => {
            const fecha = new Date(val);
            const hoy = new Date();
            const edad = hoy.getFullYear() - fecha.getFullYear();
            return edad > 18 || (edad === 18 && hoy >= new Date(fecha.setFullYear(fecha.getFullYear()+18)));
        });
        valido &= validarCampo(importe, "errImporte", val => parseFloat(val) <= importeFactura);
        valido &= validarCampo(plazo, "errPlazo");
        submitBtn.disabled = !valido;
        return valido;
    }

    inputs.forEach(input => {
        input.addEventListener("input", () => {
            validarFormulario();
            if (input.id === "importe" || input.id === "plazo") calcular();
        });
    });

    function calcular() {
        const importeVal = parseFloat(importe.value);
        const plazoVal = parseInt(plazo.value);
        if (!isNaN(importeVal) && !isNaN(plazoVal) && importeVal <= importeFactura) {
            const comision = importeVal * 0.02;
            const totalFinanciar = importeVal + comision;
            const cuota = totalFinanciar / plazoVal;
            resultados.innerHTML = `Cuota mensual: <b>${cuota.toFixed(2)} €</b><br>Comisión de apertura: <b>${comision.toFixed(2)} €</b>`;
            resultados.classList.add("show");
        } else {
            resultados.classList.remove("show");
        }
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!validarFormulario()) return;
        const payload = {
            token_inicial: token,
            nombre: nombre.value,
            apellido1: apellido1.value,
            apellido2: apellido2.value,
            fechaNacimiento: fechaNacimiento.value,
            telefono: telefono.value,
            email: email.value,
            importe: parseFloat(importe.value),
            plazo: parseInt(plazo.value),
            cuota: resultados.textContent.match(/Cuota mensual:.*?(\d+,\d+|\d+\.\d+)/)?.[1] || "",
            comision: resultados.textContent.match(/Comisión de apertura:.*?(\d+,\d+|\d+\.\d+)/)?.[1] || "",
            fechaEnvio: new Date().toISOString()
        };
        try {
            const resp = await fetch("URL_DE_TU_FLOW", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (resp.ok) {
                showToast("Formulario enviado correctamente");
                bloquearFormulario(); // Bloquear todo tras éxito
            } else {
                showToast("Error en el envío", true);
            }
        } catch {
            showToast("Error de conexión", true);
        }
    });

    function bloquearFormulario() {
        inputs.forEach(el => {
            el.disabled = true;
            el.classList.add("disabled");
        });
        submitBtn.disabled = true;
    }

    function showToast(msg, error = false) {
        const toast = document.getElementById("toastMsg");
        toast.textContent = msg;
        toast.style.backgroundColor = error ? "#dc3545" : "#28a745";
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 4000);
    }
</script>
</body>
</html>
