<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Solicitud de Financiación ISEN Centro Universitario: Sabadell Consumer Finance</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f8fa; margin: 0; padding: 0; }
    header {
      background-color: #002b5c;
      color: white;
      padding: 20px;
      text-align: center;
    }
    header img {
      max-height: 80px;
      display: block;
      margin: 0 auto 10px auto;
    }
    header h2 { margin: 0; font-size: 1.4em; }
    header p { margin: 5px 0 0; font-size: 1.1em; }
    form {
      background: white;
      max-width: 700px;
      margin: 30px auto;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label { font-weight: bold; display: block; margin-top: 15px; }
    input, select {
      margin-top: 5px;
      padding: 8px;
      width: 50%;
      min-width: 200px;
      display: block;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .importe-section {
      margin-top: 30px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f9fafc;
    }
    .importe-section p {
      font-size: 0.95em;
      color: #333;
      margin-bottom: 15px;
    }
    #resultado, #comision, #errorMensaje {
      margin-top: 10px;
      font-size: 1em;
    }
    #resultado, #comision { color: green; }
    #errorMensaje { color: red; }
    button {
      padding: 10px 20px;
      background-color: #0078D4;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 20px;
      border-radius: 4px;
      font-size: 1em;
    }
    button:disabled {
      background-color: gray;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<header>
  <img src="https://i.postimg.cc/RNDGS5W7/isen-centro-univ.jpg" alt="ISEN Centro Universitario">
  <h2>Solicitud de Financiación</h2>
  <p id="facturaInfo"></p>
</header>

<form id="simuladorForm">
  <label>Nombre:</label>
  <input type="text" id="nombre" required>

  <label>Apellido 1:</label>
  <input type="text" id="apellido1" required>

  <label>Apellido 2:</label>
  <input type="text" id="apellido2" required>

  <label>Fecha de nacimiento:</label>
  <input type="date" id="fechaNacimiento" required>

  <label>Teléfono móvil:</label>
  <input type="text" id="telefono" required>

  <label>Email:</label>
  <input type="email" id="email" required>

  <div class="importe-section">
    <p>A continuación introduzca el importe a financiar y seleccione uno de los plazos disponibles para poder obtener la cuota mensual de su solicitud de financiación. Esta cuota ya lleva incluida y prorrateada la comisión de apertura que aparece debajo. También, recordarle que el importe a financiar será como máximo el importe total de su factura o una cantidad inferior a ésta.</p>
    
    <label>Importe (€):</label>
    <input type="number" id="importe" required min="1" step="0.01">

    <label>Plazo (meses):</label>
    <select id="plazo" required>
      <option value="">Selecciona...</option>
      <option value="6">6</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="12">12</option>
    </select>
  </div>

  <div id="resultado"></div>
  <div id="comision"></div>
  <div id="errorMensaje"></div>
  <button type="submit">Calcular y enviar</button>
</form>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  let numFactura = '';
  let importeMax = 0;

  // Decodificar token (Base64)
  if (token) {
    try {
      const decoded = atob(token);
      const partes = decoded.split('|'); // IDFRA|DNI|AÑO|NUMFACTURA|IMPORTE
      if (partes.length >= 5) {
        numFactura = partes[3];
        importeMax = parseFloat(partes[4]);
        document.getElementById('facturaInfo').textContent =
          `Factura Nº ${numFactura} — Importe máximo financiable: ${importeMax} €`;
      }
    } catch (e) {
      console.error('Error al decodificar el token', e);
    }
  }

  const form = document.getElementById("simuladorForm");
  const resultadoDiv = document.getElementById("resultado");
  const comisionDiv = document.getElementById("comision");
  const errorMensaje = document.getElementById("errorMensaje");
  const boton = form.querySelector("button");

  function getComisionPorPlazo(plazo) {
    const comisiones = {6: 0.025, 9: 0.036, 10: 0.0425, 12: 0.0475};
    return comisiones[plazo] || 0;
  }
  function calcularCuota(importe, plazo) {
    const comision = getComisionPorPlazo(plazo);
    return (((importe * comision) + importe) / plazo).toFixed(2);
  }
  function calcularComisionTotal(importe, plazo) {
    const comision = getComisionPorPlazo(plazo);
    return (importe * comision).toFixed(2);
  }
  function mostrarErrores(mensaje) {
    errorMensaje.textContent = mensaje;
    resultadoDiv.textContent = '';
    comisionDiv.textContent = '';
  }
  function limpiarErrores() {
    errorMensaje.textContent = '';
  }
  function esMayorDeEdad(fechaStr) {
    const hoy = new Date();
    const nacimiento = new Date(fechaStr);
    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const m = hoy.getMonth() - nacimiento.getMonth();
    if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) edad--;
    return edad >= 18;
  }
  function validarEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }
  function validarTelefono(telefono) {
    return /^([6|7])[0-9]{8}$/.test(telefono);
  }

  form.addEventListener('input', () => {
    limpiarErrores();
    const imp = parseFloat(document.getElementById("importe").value);
    const pl = parseInt(document.getElementById("plazo").value);
    if (!isNaN(imp) && !isNaN(pl)) {
      if (importeMax > 0 && imp > importeMax) {
        mostrarErrores(`El importe no puede superar ${importeMax} €`);
        return;
      }
      const cuota = calcularCuota(imp, pl);
      const comision = calcularComisionTotal(imp, pl);
      resultadoDiv.textContent = `Cuota mensual estimada: ${cuota} €`;
      comisionDiv.textContent = `Comisión total: ${comision} €`;
    } else {
      resultadoDiv.textContent = '';
      comisionDiv.textContent = '';
    }
  });

  form.addEventListener('submit', e => {
    e.preventDefault();
    limpiarErrores();

    const nombre = document.getElementById("nombre").value.trim();
    const apellido1 = document.getElementById("apellido1").value.trim();
    const apellido2 = document.getElementById("apellido2").value.trim();
    const fechaNacimiento = document.getElementById("fechaNacimiento").value;
    const telefono = document.getElementById("telefono").value.trim();
    const email = document.getElementById("email").value.trim();
    const imp = parseFloat(document.getElementById("importe").value);
    const pl = parseInt(document.getElementById("plazo").value);

    if (!nombre || nombre.length < 3) return mostrarErrores("El nombre debe tener al menos 3 caracteres.");
    if (!apellido1 || apellido1.length < 3) return mostrarErrores("El primer apellido debe tener al menos 3 caracteres.");
    if (!apellido2 || apellido2.length < 3) return mostrarErrores("El segundo apellido debe tener al menos 3 caracteres.");
    if (!fechaNacimiento || !esMayorDeEdad(fechaNacimiento)) return mostrarErrores("Debes ser mayor de edad (mínimo 18 años).");
    if (!validarTelefono(telefono)) return mostrarErrores("El teléfono debe tener 9 dígitos y comenzar por 6 o 7.");
    if (!validarEmail(email)) return mostrarErrores("Introduce un email válido.");
    if (isNaN(imp) || imp <= 0) return mostrarErrores("El importe debe ser mayor que 0.");
    if (importeMax > 0 && imp > importeMax) return mostrarErrores(`El importe no puede superar ${importeMax} €.`);
    if (isNaN(pl)) return mostrarErrores("Selecciona un plazo válido.");

    const cuota = calcularCuota(imp, pl);
    const comision = calcularComisionTotal(imp, pl);

    const datos = {
      nombre,
      apellido1,
      apellido2,
      fechaNacimiento,
      telefono,
      email,
      importe: imp,
      plazo: pl,
      cuota,
      comision,
      fechaEnvio: new Date().toISOString(),
      token
    };

    fetch('AQUI_TU_URL_DE_POWER_AUTOMATE', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(datos)
    }).then(res => {
      if (!res.ok) throw new Error("Error de red o del servidor");
      alert('Gracias, simulación enviada correctamente.');
      boton.disabled = true;
    }).catch(err => {
      mostrarErrores("Error al enviar el formulario. Intenta nuevamente más tarde.\n" + err.message);
    });
  });
</script>
</body>
</html>
